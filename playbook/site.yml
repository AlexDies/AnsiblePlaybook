---
- name: Install Elasticsearch
  hosts: elasticsearch
  roles:
    - elastic
- name: Install kibana
  hosts: kibana
  roles:
    - kibana
  # handlers:
  #   - name: restart Elasticsearch
  #     become: true
  #     systemd:
  #       name: elasticsearch
  #       state: restarted
  #       enabled: true
  # tasks:
  #   - name: "Download Elasticsearch's rpm"
  #     get_url:
  #       url: "https://artifacts.elastic.co/downloads/elasticsearch/elasticsearch-{{ elk_stack_version }}-x86_64.rpm"
  #       dest: "/tmp/elasticsearch-{{ elk_stack_version }}-x86_64.rpm"
  #     register: download_elastic
  #     until: download_elastic is succeeded
  #   - name: Install Elasticsearch
  #     become: true
  #     yum:
  #       name: "/tmp/elasticsearch-{{ elk_stack_version }}-x86_64.rpm"
  #       state: present
  #     notify: restart Elasticsearch
  #   - name: Configure Elasticsearch
  #     become: true
  #     template:
  #       src: elasticsearch.yml.j2
  #       dest: /etc/elasticsearch/elasticsearch.yml
  #       mode: 0644
  #     notify: restart Elasticsearch

# - name: Install Kibana
#   hosts: kibana
#   handlers:
#     - name: restart Kibana
#       become: true
#       systemd:
#         name: kibana
#         state: restarted
#         enabled: true
#   tasks:
#     - name: "Download Kibana rpm"
#       get_url:
#         url: "https://artifacts.elastic.co/downloads/kibana/kibana-{{ kibana_version }}-x86_64.rpm"
#         dest: "/tmp/kibana-{{ kibana_version }}-x86_64.rpm"
#       register: download_kibana
#       until: download_kibana is succeeded
#     - name: Install Kibana
#       become: true
#       yum:
#         name: "/tmp/kibana-{{ kibana_version }}-x86_64.rpm"
#         state: present
#       notify: restart Kibana
#     - name: Configure Kibana
#       become: true
#       template:
#         src: kibana.yml.j2
#         dest: /etc/kibana/kibana.yml
#         mode: 0644
#       notify: restart Kibana
# - name: Install filebeat
#   hosts: app
#   handlers:
#     - name: restart filebeat
#       become: true
#       systemd:
#         name: filebeat
#         state: restarted
#         enabled: true
#   tasks:
#     - name: "Download filebeat"
#       get_url:
#         url: "https://artifacts.elastic.co/downloads/beats/filebeat/filebeat-{{ filebeat_version }}-x86_64.rpm"
#         dest: "/tmp/filebeat-{{ filebeat_version }}-x86_64.rpm"
#       register: download_filebeat
#       until: download_filebeat is succeeded
#     - name: "Install filebeat"
#       become: true
#       yum:
#         name: "/tmp/filebeat-{{ filebeat_version }}-x86_64.rpm"
#         state: present
#       notify: restart filebeat
#     - name: "Configure filebeat"
#       become: true
#       template:
#         src: filebeat.yml.j2
#         dest: /etc/filebeat/filebeat.yml
#         mode: 0644
#       notify: restart filebeat
#     - name: "Set filebeat systemwork"
#       become: true
#       command:
#         cmd: filebeat modules enable system
#         chdir: /usr/share/filebeat/bin
#       register: filebeat_modules
#       changed_when: filebeat_modules.stdout !='Module system is already enabled'
#     - name: "Load kibana dashboard"
#       become: true
#       command:
#         cmd: filebeat setup
#         chdir: /usr/share/filebeat/bin
#       register: filebeat_setup
#       changed_when: false
#       until: filebeat_setup is succeeded
